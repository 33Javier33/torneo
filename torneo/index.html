<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualización de Torneo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1e293b;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 1.5rem;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s, transform 0.3s ease;
            transform-origin: top center;
        }
        .container {
            width: 100%;
            max-width: 1800px; /* Aumentado para un layout más ancho */
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .title-section {
            margin-bottom: 2rem;
            width: 100%;
        }

        /* --- ESTILOS PARA TARJETAS GIRATORIAS CON NOMBRE EN DOS LÍNEAS --- */
        .participant-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 100%;
        }
        .flip-card {
            background-color: transparent;
            height: 70px; /* Aumentada la altura para dos líneas */
            perspective: 1000px;
            width: 100%;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }
        .flip-card.is-flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
        }
        .flip-card-front {
            background-color: #f1f5f9;
            color: #1e293b;
            flex-direction: column; /* Para poner los apellidos abajo */
            line-height: 1.2; /* Ajuste de interlineado */
        }
        .flip-card-back {
            background-color: #2563eb;
            color: white;
            transform: rotateY(180deg);
            font-size: 1.5rem;
        }
        
        /* --- ESTILOS PARA RANKING DESTACADO --- */
        .highlighted-rank {
            border: 2px solid #f59e0b;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        /* --- CONTROLES DE ZOOM --- */
        .zoom-controls {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            z-index: 100;
            display: flex;
            gap: 0.5rem;
        }
        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: white;
            color: #1e293b;
            border: 1px solid #e2e8f0;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- MODO OSCURO --- */
        body.dark { background-color: #0f172a; color: #e2e8f0; }
        .dark .card { background-color: #1e293b; border: 1px solid #334155; }
        .dark #tournamentTitle { color: #93c5fd; }
        .dark #tournamentDate { color: #94a3b8; }
        .dark #clockDisplay { color: #60a5fa; }
        .dark .bg-slate-100 { background-color: #334155; }
        .dark .font-bold.text-slate-400 { color: #94a3b8; }
        .dark .font-semibold.text-slate-800 { color: #e2e8f0; }
        .dark .text-blue-600.bg-white { background-color: #0f172a; color: #93c5fd; }
        .dark .text-gray-500 { color: #94a3b8; }
        .dark footer { color: #64748b; }
        .dark .flip-card-front { background-color: #334155; color: #e2e8f0; }
        .dark .flip-card-front .text-slate-500 { color: #94a3b8; }
        .dark .flip-card-back { background-color: #60a5fa; color: #0f172a; }
        .dark .zoom-btn { background-color: #1e293b; color: #e2e8f0; border-color: #334155; }
        .dark .highlighted-rank { border-color: #fcd34d; box-shadow: 0 0 10px rgba(252, 211, 77, 0.5); }

        /* --- INTERRUPTOR DE TEMA --- */
        .theme-switch-wrapper { position: fixed; top: 1rem; right: 1rem; z-index: 100; }
        .theme-switch { display: inline-block; height: 34px; position: relative; width: 60px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 26px; left: 4px; position: absolute; transition: .4s; width: 26px; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body>

    <div class="theme-switch-wrapper">
        <label class="theme-switch" for="checkbox">
            <input type="checkbox" id="checkbox" />
            <div class="slider round"></div>
        </label>
    </div>

    <div id="classificationScreen" class="w-full">
        <div class="title-section text-center">
            <h1 id="tournamentTitle" class="text-4xl md:text-5xl font-extrabold text-blue-900 mb-4">Cargando Torneo...</h1>
        </div>
        <!-- NUEVA ESTRUCTURA DE GRID: 4 columnas para un layout más horizontal -->
        <div class="container grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- Columna de Puntajes (ocupa 1 de 4 columnas) -->
            <section class="card">
                <h2 class="text-2xl font-bold mb-4">MEJORES PUNTAJES</h2>
                <ul id="participantList" class="participant-list"></ul>
            </section>
            
            <!-- Columna Central (ocupa 2 de 4 columnas) -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                <section class="card">
                    <h2 class="text-2xl font-bold">HORA</h2>
                    <p id="tournamentDate" class="text-xl font-bold text-gray-600"></p>
                    <div id="clockDisplay" class="font-mono text-5xl font-extrabold text-blue-600 my-4">00:00:00</div>
                    <div id="registration-status" class="mt-auto pt-4 text-center">
                        <p id="endTimeDisplay" class="font-bold text-gray-700 dark:text-gray-300"></p>
                        <div id="warningMessage" class="hidden">
                            <p class="font-bold text-red-600 animate-pulse">TÉRMINO DE INSCRIPCIONES</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Advertencia: 20 minutos para el cierre.</p>
                        </div>
                    </div>
                </section>
                <section class="card">
                    <h2 class="text-2xl font-bold mb-4">PREMIOS</h2>
                    <div class="text-center">
                        <p class="text-gray-600 font-bold">POZO TOTAL</p>
                        <p id="totalPrize" class="text-4xl font-extrabold text-green-600 mb-4">$0</p>
                    </div>
                    <div id="prizeDistribution" class="w-full space-y-2"></div>
                </section>
            </div>

            <!-- Columna de Ranking (ocupa 1 de 4 columnas) -->
            <section class="card">
                <h2 id="rankingTitle" class="text-2xl font-bold mb-4">Ranking</h2>
                <ol id="rankingList" class="w-full space-y-4"></ol>
            </section>
        </div>
    </div>

    <!-- PANTALLAS FINAL Y GANADORES (sin cambios) -->
    <div id="finalScreen" class="hidden"></div>
    <div id="winnersScreen" class="hidden"></div>

    <div class="zoom-controls">
        <button id="zoom-in" class="zoom-btn">+</button>
        <button id="zoom-out" class="zoom-btn">-</button>
    </div>

    <footer class="mt-auto pt-8 text-center text-gray-500 text-sm">
        <p>CarlosPN Interactive®</p>
    </footer>

    <script>
        let currentZoom = 1.0;
        let cardFlipInterval;

        const themeSwitch = document.getElementById('checkbox');
        const classificationScreen = document.getElementById('classificationScreen');

        const TOURNAMENTS = {
            ruleta: { name: 'Torneo de Ruleta', playersPerTable: 5, rounds: ['Bolita 1', 'Bolita 2', 'Bolita 3'] },
            draw_poker: { name: 'Torneo de Draw Poker', playersPerTable: 6, rounds: ['Puntaje'] },
            blackjack: { name: 'Torneo de Blackjack', playersPerTable: 6, rounds: ['Puntaje'] },
            ruleta_vip: { name: 'Torneo de Ruleta VIP', playersPerTable: 5, rounds: ['Bolita 1', 'Bolita 2', 'Bolita 3'] },
            draw_poker_vip: { name: 'Torneo de Draw Poker VIP', playersPerTable: 6, rounds: ['Puntaje'] },
            blackjack_vip: { name: 'Torneo de Blackjack VIP', playersPerTable: 6, rounds: ['Puntaje'] }
        };

        // --- FUNCIONES DE UTILIDAD ---
        function getTournamentType() { return localStorage.getItem('selectedTournament') || 'ruleta'; }
        function getClients() { return JSON.parse(localStorage.getItem(`clientes_${getTournamentType()}`) || '[]'); }
        function formatNumber(num) { return Number(num).toLocaleString('es-CL'); }
        function getTournamentDate() {
            const dateStr = localStorage.getItem('tournamentDate');
            if (!dateStr) return 'Fecha no definida';
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }

        // --- LÓGICA DE CÁLCULO Y ORDENAMIENTO ---
        function calculateTotal(client, tournamentType) {
            const cleanValue = (val) => parseInt(String(val || '0').replace(/\./g, ''));
            const tournament = TOURNAMENTS[tournamentType];
            if (!tournament) return 0;
            return tournament.rounds.reduce((total, round) => {
                const scoreKey = round.toLowerCase().replace(/ /g, '');
                return total + cleanValue(client[scoreKey]);
            }, 0);
        }
        
        function getBestEntryPerPlayer(allEntries, tournamentType) {
            const playersMap = new Map();
            allEntries.forEach(entry => {
                const totalScore = calculateTotal(entry, tournamentType);
                const existingEntry = playersMap.get(entry.rut);
                if (!existingEntry || totalScore > existingEntry.totalScore) {
                    playersMap.set(entry.rut, { ...entry, totalScore });
                }
            });
            return Array.from(playersMap.values());
        }

        function getSortedClients(clients) {
             return [...clients].sort((a, b) => b.totalScore - a.totalScore);
        }

        // --- RENDERIZADO DE VISTAS ---
        function updateView() {
            const currentView = localStorage.getItem('tournamentView') || 'classification';
            classificationScreen.style.display = 'none';
            if (currentView === 'classification') {
                classificationScreen.style.display = 'block';
                renderClassificationScreen();
            }
        }

        function renderClassificationScreen() {
            const tournamentType = getTournamentType();
            const allEntries = getClients();
            const participantList = document.getElementById('participantList');
            const rankingList = document.getElementById('rankingList');
            participantList.innerHTML = '';
            rankingList.innerHTML = '';

            const tournament = TOURNAMENTS[tournamentType];
            if (!tournament) return;

            document.getElementById('tournamentTitle').textContent = tournament.name;
            const uniquePlayers = getBestEntryPerPlayer(allEntries, tournamentType);
            const sortedByScore = getSortedClients(uniquePlayers);
            
            // RENDERIZAR TARJETAS GIRATORIAS (TOP 10)
            const topParticipants = sortedByScore.slice(0, 10);
            if (topParticipants.length === 0) {
                participantList.innerHTML = '<li class="text-gray-500 italic">Aún no hay participantes.</li>';
            } else {
                topParticipants.forEach(player => {
                    const li = document.createElement('li');
                    
                    const nameParts = (player.nombre || '').split(' ');
                    const lastNameParts = (player.apellido || '').split(' ');

                    const firstNames = nameParts.slice(0, 2).join(' ');
                    const lastNames = lastNameParts.slice(0, 2).join(' ');

                    li.className = 'flip-card';
                    li.innerHTML = `
                        <div class="flip-card-inner">
                            <div class="flip-card-front" title="${player.nombre} ${player.apellido}">
                                <span class="font-bold">${firstNames}</span>
                                <span class="text-sm text-slate-500">${lastNames}</span>
                            </div>
                            <div class="flip-card-back">
                                <span>${formatNumber(player.totalScore)}</span>
                            </div>
                        </div>
                    `;
                    participantList.appendChild(li);
                });
            }
            if (cardFlipInterval) clearInterval(cardFlipInterval);
            cardFlipInterval = setInterval(() => {
                document.querySelectorAll('.flip-card').forEach(card => {
                    card.classList.toggle('is-flipped');
                });
            }, 4000);

            // RENDERIZAR RANKING (TOP 10 CON DESTACADOS)
            const topRankedClients = sortedByScore.slice(0, 10);
            const highlightCount = tournament.playersPerTable;
            document.getElementById('rankingTitle').textContent = `Ranking (Top ${highlightCount} clasifican)`;
            if (topRankedClients.length === 0) {
                rankingList.innerHTML = '<li class="text-gray-500 italic">El ranking se mostrará aquí.</li>';
            } else {
                topRankedClients.forEach((client, index) => {
                    const li = document.createElement('li');
                    const isHighlighted = index < highlightCount;
                    li.className = `bg-slate-100 p-4 rounded-lg flex justify-between items-center ${isHighlighted ? 'highlighted-rank' : ''}`;
                    li.innerHTML = `
                        <div class="flex items-center">
                            <span class="font-bold text-slate-400 text-lg w-8 text-left">${index + 1}.</span>
                            <span class="font-semibold text-slate-800">${client.nombre} ${client.apellido}</span>
                        </div>
                        <span class="text-lg font-bold text-blue-600 bg-white px-3 py-1 rounded-md shadow-sm">${formatNumber(client.totalScore)}</span>`;
                    rankingList.appendChild(li);
                });
            }
            
            // RENDERIZAR PREMIOS
            const prizePool = parseInt(localStorage.getItem('prizePool') || '0');
            document.getElementById('totalPrize').textContent = `$${formatNumber(prizePool)}`;
            const prizeDistributionDiv = document.getElementById('prizeDistribution');
            prizeDistributionDiv.innerHTML = '';
            if (prizePool > 0) {
                const prizes = [
                    { label: '1er Lugar (50%)', amount: prizePool * 0.5, color: 'text-yellow-500' },
                    { label: '2do Lugar (30%)', amount: prizePool * 0.3, color: 'text-gray-500' },
                    { label: '3er Lugar (20%)', amount: prizePool * 0.2, color: 'text-amber-700' }
                ];
                prizes.forEach(prize => {
                    const p = document.createElement('p');
                    p.className = `font-semibold flex justify-between w-full`;
                    p.innerHTML = `<span>${prize.label}</span> <span class="${prize.color} font-bold">$${formatNumber(prize.amount)}</span>`;
                    prizeDistributionDiv.appendChild(p);
                });
            } else {
                prizeDistributionDiv.innerHTML = '<p class="text-gray-400 italic">No se ha definido un pozo.</p>';
            }
        }
        
        // --- FUNCIONES DE RELOJ Y ESTADO ---
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('clockDisplay').textContent = timeString;
        }

        function checkRegistrationStatus() {
            const endTimeString = localStorage.getItem('registrationEndTime');
            const statusContainer = document.getElementById('registration-status');
            const endTimeDisplay = document.getElementById('endTimeDisplay');
            const warningMessage = document.getElementById('warningMessage');

            if (!endTimeString) {
                statusContainer.classList.add('hidden');
                return;
            }
            
            statusContainer.classList.remove('hidden');
            const [hours, minutes] = endTimeString.split(':');
            const now = new Date();
            const endTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0);
            const minutesRemaining = (endTime.getTime() - now.getTime()) / 60000;

            endTimeDisplay.textContent = `Cierre de inscripciones a las ${endTimeString} hrs.`;
            if (minutesRemaining > 0 && minutesRemaining <= 20) {
                warningMessage.classList.remove('hidden');
            } else {
                warningMessage.classList.add('hidden');
            }
        }

        // --- INICIALIZACIÓN Y EVENTOS ---
        document.addEventListener('DOMContentLoaded', () => {
            function toggleDarkMode(isDark) {
                document.body.classList.toggle('dark', isDark);
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            }
            const currentTheme = localStorage.getItem('theme');
            if (currentTheme === 'dark') {
                themeSwitch.checked = true;
                toggleDarkMode(true);
            }
            themeSwitch.addEventListener('change', (e) => toggleDarkMode(e.target.checked));

            document.getElementById('zoom-in').addEventListener('click', () => {
                currentZoom = Math.min(2.0, currentZoom + 0.1);
                document.body.style.transform = `scale(${currentZoom})`;
            });
            document.getElementById('zoom-out').addEventListener('click', () => {
                currentZoom = Math.max(0.5, currentZoom - 0.1);
                document.body.style.transform = `scale(${currentZoom})`;
            });

            document.getElementById('tournamentDate').textContent = getTournamentDate();
            
            updateView();
            setInterval(() => {
                updateClock();
                checkRegistrationStatus();
            }, 1000);

            window.addEventListener('storage', (event) => {
                if (event.key.startsWith('clientes_') || event.key === 'tournamentView' || event.key === 'prizePool' || event.key === 'selectedTournament' || event.key === 'registrationEndTime') {
                    updateView();
                }
                if (event.key === 'tournamentDate') {
                    document.getElementById('tournamentDate').textContent = getTournamentDate();
                }
            });
        });
    </script>
</body>
</html>

